<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>버섯 생육 시뮬레이션 뷰어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0e11; --card:#141a20; --text:#e7edf3; --muted:#9fb0c0; --accent:#66d9e8; }
    * { box-sizing: border-box; }
    body { margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background:var(--bg); color:var(--text); }
    header { padding:20px 24px; border-bottom:1px solid #1e2730; }
    h1 { margin:0 0 6px; font-size:20px; }
    .sub { color:var(--muted); font-size:14px; }
    .wrap { max-width:1100px; margin:0 auto; padding:20px 24px 40px; display:grid; gap:16px; grid-template-columns: 320px 1fr; }
    .card { background:var(--card); border:1px solid #1e2730; border-radius:16px; padding:16px; }
    .controls label { display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
    select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a3540; background:#0f141a; color:var(--text); outline:none; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
    .hint { font-size:12px; color:var(--muted); margin-top:8px; }
    .video-card { display:flex; flex-direction:column; gap:12px; }
    video { width:100%; max-height:70vh; border-radius:16px; outline:none; background:#000; }
    .badge { display:inline-block; padding:6px 10px; border:1px solid #2a3540; border-radius:999px; font-size:12px; color:var(--muted); }
    .status { font-size:13px; color:var(--muted); }
    .err { color:#ffa8a8; }
    footer { text-align:center; color:var(--muted); font-size:12px; padding:20px 0 40px; }
    button { padding:10px 14px; border-radius:10px; border:1px solid #2a3540; background:#0f141a; color:var(--text); cursor:pointer; }
    button:hover { border-color:#334454; }
    .actions { display:flex; gap:10px; align-items:center; }
  </style>
</head>
<body>
  <header>
    <h1>버섯 생육 시뮬레이션</h1>
    <div class="sub">온도/습도 조건을 선택하면 해당 조건의 3D 시뮬레이션이 자동 재생됩니다 (무음 자동재생).</div>
  </header>

  <main class="wrap">
    <!-- 좌측: 컨트롤 -->
    <section class="card controls">
      <div class="row">
        <div>
          <label for="temp">생육 온도(°C)</label>
          <select id="temp">
            <option value="21">21</option>
            <option value="18">18</option>
            <option value="15">15</option>
          </select>
        </div>
        <div>
          <label for="hum">상대습도(%)</label>
          <select id="hum">
            <option value="60">60</option>
            <option value="80" selected>80</option>
            <option value="99">99</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="co2">CO₂(ppm) <span class="badge">선택</span></label>
          <select id="co2">
            <option value="na" selected>—</option>
            <option value="800">800</option>
            <option value="1200">1200</option>
          </select>
        </div>
        <div>
          <label for="light">조도(Lux) <span class="badge">선택</span></label>
          <select id="light">
            <option value="na" selected>—</option>
            <option value="500">500</option>
            <option value="1500">1500</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="playBtn">재생</button>
        <button id="pauseBtn">일시정지</button>
        <span class="hint">파일명 규칙: <code>mushroom_T{온도}_H{습도}.mp4</code></span>
      </div>
    </section>

    <!-- 우측: 비디오 -->
    <section class="card video-card">
      <div class="status" id="status">파일을 찾는 중…</div>
      <video id="player" muted autoplay playsinline preload="metadata" controls poster="">
        <!-- 소스는 JS로 설정 -->
        브라우저가 비디오 태그를 지원하지 않습니다.
      </video>
      <div class="hint">자동재생은 **무음(muted)**일 때 보장됩니다. 사운드가 필요하면 음소거를 해제하세요.</div>
    </section>
  </main>

  <footer>© 2025 Mushroom Simulation • Blender 기반 3D 시뮬레이션 데모</footer>

  <script>
    // ① 파일 맵: 필요 시 사용자 환경에 맞게 경로만 수정
    // 기본 규칙: assets/videos/mushroom_T{temp}_H{hum}.mp4
    const base = "assets/videos";
    function buildKey({ temp, hum, co2, light }) {
      // 최소 키는 T+H. CO₂/조도는 있는 경우에만 변형을 허용하려면 아래 라인을 응용
      return `mushroom_T${temp}_H${hum}.mp4`;
    }

    // ② 동적 포스터(썸네일) 파일 규칙(있으면 사용)
    function buildPoster({ temp, hum }) {
      const posterPath = `${base}/posters/mushroom_T${temp}_H${hum}.jpg`;
      return posterPath;
    }

    // ③ 초기 요소
    const selTemp = document.getElementById("temp");
    const selHum  = document.getElementById("hum");
    const selCO2  = document.getElementById("co2");
    const selLight= document.getElementById("light");
    const player  = document.getElementById("player");
    const statusEl= document.getElementById("status");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn= document.getElementById("pauseBtn");

    // ④ 유틸
    const existsCache = new Map();
    async function fileExists(url) {
      if (existsCache.has(url)) return existsCache.get(url);
      try {
        const res = await fetch(url, { method: "HEAD" });
        const ok = res.ok;
        existsCache.set(url, ok);
        return ok;
      } catch (e) {
        existsCache.set(url, false);
        return false;
      }
    }

    function getSelections() {
      return {
        temp: selTemp.value,
        hum:  selHum.value,
        co2:  selCO2.value,
        light:selLight.value
      };
    }

    async function loadVideo() {
      const opts = getSelections();
      const fileName = buildKey(opts);
      const src = `${base}/${fileName}`;
      statusEl.textContent = `조건: T${opts.temp}°C / H${opts.hum}% → 파일 확인 중…`;

      if (await fileExists(src)) {
        // 소스 교체
        player.pause();
        player.removeAttribute("src"); // Safari 캐시 우회
        player.src = src;

        // 포스터(있으면 적용, 없어도 무방)
        const poster = buildPoster(opts);
        if (await fileExists(poster)) {
          player.setAttribute("poster", poster);
        } else {
          player.removeAttribute("poster");
        }

        // 자동 재생 시도
        try {
          await player.play();
          statusEl.innerHTML = `재생 중: <code>${fileName}</code>`;
          statusEl.classList.remove("err");
        } catch (err) {
          statusEl.innerHTML = `자동재생이 차단되어 <b>재생 버튼</b>을 눌러주세요.`;
          statusEl.classList.add("err");
        }
      } else {
        statusEl.innerHTML = `해당 조합의 영상 파일이 없습니다: <code>${fileName}</code>`;
        statusEl.classList.add("err");
        player.pause();
        player.removeAttribute("src");
        player.load();
      }
    }

    // ⑤ 이벤트: 선택 변경 시 바로 로드
    [selTemp, selHum, selCO2, selLight].forEach(el => {
      el.addEventListener("change", () => loadVideo());
    });

    // ⑥ 버튼
    playBtn.addEventListener("click", () => player.play());
    pauseBtn.addEventListener("click", () => player.pause());

    // ⑦ 초기 로드
    window.addEventListener("DOMContentLoaded", loadVideo);
  </script>
</body>
</html>

