<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>버섯 생육 시뮬레이션 뷰어</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0b0e11; --card:#141a20; --line:#213040; --text:#e9f0f5; --muted:#9fb0c0; --panel:#0e1319; }
    *{box-sizing:border-box}
    body{font-family:system-ui, Arial,"Noto Sans KR"; background:var(--bg); color:var(--text); margin:0}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 16px; border-bottom:1px solid #16202a}
    h1{margin:0; font-size:20px}
    .sub{color:var(--muted); font-size:13px}
    .toolbar{display:flex; gap:8px}
    .btn{padding:8px 12px; border-radius:10px; border:1px solid #2a3847; background:#0f141a; color:var(--text); cursor:pointer}
    .btn:hover{border-color:#415e7a}
    main{display:grid; grid-template-columns:360px 1fr; gap:16px; padding:16px; max-width:1400px; margin:0 auto}
    .card{background:var(--card); padding:16px; border-radius:12px; border:1px solid var(--line)}
    h2{margin:12px 0 10px; font-size:16px}
    label{font-size:12px; display:block; margin:10px 0 6px; color:var(--muted)}
    select{width:100%; padding:8px 10px; border-radius:8px; background:#0f141a; color:var(--text); border:1px solid #2a3847}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .hint{font-size:12px; color:var(--muted); margin-top:10px; line-height:1.5}
    .stack{display:grid; gap:16px}
    .vcard{padding:12px; border-radius:12px; background:#0e1319; border:1px solid #1e2a36}
    .vtitle{display:flex; align-items:center; gap:8px; margin:4px 0 8px; color:#c2d2e2; font-size:14px}
    .badge{font-size:11px; padding:2px 8px; border:1px solid #32516d; border-radius:999px; color:#d5e9ff}
    video{width:100%; border-radius:10px; background:#000; max-height:48vh}
    .status{font-size:13px; color:var(--muted); min-height:1.2em; margin-top:6px}

    /* 사이드 패널(매뉴얼) */
    .sidepanel{position:fixed; top:0; right:0; width:420px; max-width:90vw; height:100vh; background:var(--panel); border-left:1px solid #1c2a38;
      transform:translateX(100%); transition:.28s ease; display:flex; flex-direction:column; z-index:50}
    .sidepanel.open{transform:translateX(0)}
    .phead{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 12px; border-bottom:1px solid #1c2a38}
    .tabs{display:flex; gap:8px}
    .tab{padding:8px 12px; border-radius:8px; background:#101823; border:1px solid #1f2b38; color:#cfe3f7; cursor:pointer}
    .tab.active{background:#1b2735; border-color:#35506d}
    .pcontent{padding:12px 14px; overflow:auto; flex:1}
    .stage{margin-bottom:16px; border:1px solid #1f2b38; border-radius:12px; padding:12px; background:#0c1117}
    .stage h3{margin:0 0 8px}
    .imgs{display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:8px}
    .imgs img{width:100%; height:150px; object-fit:cover; border-radius:10px; border:1px solid #25374a}
    .kv{display:grid; grid-template-columns:90px 1fr; gap:6px; font-size:13px; color:#b1c0cf; margin-top:6px}
    .kv b{color:#e8f1f8}
    .closeX{padding:6px 10px}

    @media (max-width:1024px){ main{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>버섯 생육 시뮬레이션</h1>
      <div class="sub">상단: 표준 영상 자동 재생 · 하단: 선택 조건/모드 비교 재생 · 우측: 표준 매뉴얼</div>
    </div>
    <div class="toolbar">
      <button id="openManual" class="btn">재배 매뉴얼 열기</button>
      <button id="playBoth" class="btn">둘다 재생</button>
      <button id="pauseBoth" class="btn">둘다 정지</button>
      <button id="syncTime" class="btn">동기화</button>
    </div>
  </header>

  <main>
    <!-- 좌측 컨트롤 -->
    <section class="card">
      <h2>Stage1</h2>
      <div class="row">
        <div>
          <label for="s1temp">온도(°C)</label>
          <select id="s1temp">
            <option value="13">13</option>
            <option value="18" selected>18</option>
            <option value="23">23</option>
          </select>
        </div>
        <div>
          <label for="s1light">광</label>
          <select id="s1light">
            <option value="on" selected>on</option>
            <option value="off">off</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="s1hum">습도(%)</label>
          <select id="s1hum" disabled>
            <option value="90" selected>90</option>
          </select>
        </div>
        <div></div>
      </div>

      <h2>Stage2</h2>
      <div class="row">
        <div>
          <label for="s2temp">온도(°C)</label>
          <select id="s2temp">
            <option value="15">15</option>
            <option value="18" selected>18</option>
          </select>
        </div>
        <div>
          <label for="s2hum">습도(%)</label>
          <select id="s2hum">
            <option value="60">60</option>
            <option value="80" selected>80</option>
            <option value="90">90</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="s2light">광</label>
          <select id="s2light">
            <option value="on" selected>on</option>
            <option value="off">off</option>
          </select>
        </div>
        <div>
          <label>솎기(조합용)</label>
          <select id="thinning" disabled>
            <option value="10" selected>10</option>
          </select>
        </div>
      </div>

      <h2>추가 보기 (환경조건 무관)</h2>
      <div class="row">
        <div>
          <label for="quality">품질 등급</label>
          <select id="quality">
            <option value="none" selected>—</option>
            <option value="quality_excellent">특상 (excellent)</option>
            <option value="quality_high">상 (high)</option>
            <option value="quality_normal">보통 (normal)</option>
          </select>
        </div>
        <div>
          <label for="aging">노화 과정</label>
          <select id="aging">
            <option value="none" selected>—</option>
            <option value="on">보기</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label for="thinMode">솎기 단독 모드</label>
          <select id="thinMode">
            <option value="off" selected>—</option>
            <option value="on">보기</option>
          </select>
        </div>
        <div>
          <label for="thinSolo">솎기(단독)</label>
          <select id="thinSolo">
            <option value="none" selected>none</option>
            <option value="5">5</option>
            <option value="10">10</option>
            <option value="20">20</option>
          </select>
        </div>
      </div>

      <div class="hint">
        조합 파일: <code>assets/videos/mushroom_S1T{13|18|23}_H90_L{on|off}_S2T{15|18}_H{60|80|90}_L{on|off}_T10.mp4</code><br>
        표준: <code>assets/videos/mushroom_S1T18_H90_Lon_S2T15_H80_Lon_T10.mp4</code><br>
        품질: <code>assets/videos/quality/{quality_excellent|quality_high|quality_normal}.mp4</code> · 노화: <code>assets/videos/aging/aging.mp4</code><br>
        솎기 단독: <code>assets/videos/thinning/thinning_{5|10|20|none}.mp4</code>
      </div>
    </section>

    <!-- 우측: 상단 기준(표준), 하단 비교 -->
    <section class="stack">
      <div class="vcard">
        <div class="vtitle">기준 플레이어 <span class="badge">표준 영상</span></div>
        <video id="stdPlayer" controls muted autoplay playsinline></video>
        <div id="stdStatus" class="status"></div>
      </div>
      <div class="vcard">
        <div class="vtitle">비교 플레이어 <span class="badge">선택 조건/모드</span></div>
        <video id="cmpPlayer" controls muted autoplay playsinline></video>
        <div id="cmpStatus" class="status"></div>
      </div>
    </section>
  </main>

  <!-- 사이드 패널: 표준 매뉴얼 / 환경조건 -->
  <aside id="panel" class="sidepanel" aria-hidden="true">
    <div class="phead">
      <strong>표준 매뉴얼</strong>
      <div class="tabs">
        <button class="tab active" data-tab="manual">매뉴얼</button>
        <button class="tab" data-tab="env">환경조건</button>
      </div>
      <button id="closeManual" class="btn closeX">닫기</button>
    </div>
    <div class="pcontent">
      <!-- 매뉴얼 -->
      <div id="manual" class="tabpage">
        <div class="stage">
          <h3>① 입상(개봉)</h3>
          <div class="imgs">
            <img src="assets/입상(개봉)_1.jpg" alt="입상(개봉) 1">
            <img src="assets/입상(개봉)_2.jpg" alt="입상(개봉) 2">
          </div>
          <div class="kv"><b>설명</b><span>배지를 개봉하고 생육 준비 단계 시작</span></div>
          <div class="kv"><b>환경</b><span>온도 18±2℃, 습도 90±1%, CO₂ 800±200ppm, 광 on</span></div>
        </div>

        <div class="stage">
          <h3>② 발이 후 생육</h3>
          <div class="imgs">
            <img src="assets/발이 후 생육_1.jpg" alt="발이 후 생육">
          </div>
          <div class="kv"><b>설명</b><span>균사가 활발히 성장하는 시기</span></div>
          <div class="kv"><b>환경</b><span>온도 15℃, 습도 80±1%, CO₂ 800±200ppm, 광 on</span></div>
        </div>

        <div class="stage">
          <h3>③ 솎기</h3>
          <div class="imgs">
            <img src="assets/솎기_1.jpg" alt="솎기">
          </div>
          <div class="kv"><b>설명</b><span>1배지당 8~10개로 솎아 균일 생육 확보</span></div>
        </div>

        <div class="stage">
          <h3>④ 솎기 후 생육</h3>
          <div class="imgs">
            <img src="assets/솎기 후 생육_1.jpg" alt="솎기 후 생육">
          </div>
          <div class="kv"><b>설명</b><span>솎기 후 균일하게 자란 버섯, 광/환기 관리 중요</span></div>
        </div>

        <div class="stage">
          <h3>⑤ 수확</h3>
          <div class="imgs">
            <img src="assets/수확_1.jpg" alt="수확">
          </div>
          <div class="kv"><b>설명</b><span>품질 구분: 특상 / 상 / 보통</span></div>
        </div>
      </div>

      <!-- 환경조건 탭 -->
      <div id="env" class="tabpage" style="display:none;">
        <h3>기본 환경조건</h3>
        <ul>
          <li>입상(개봉): 온도 18±2℃, 습도 90±1%, CO₂ 800±200ppm, 광 on</li>
          <li>발이 후 생육: 온도 15℃, 습도 80±1%, CO₂ 800±200ppm, 광 on</li>
        </ul>
        <p style="color:#9fb0c0; font-size:13px;">※ 교육용 예시입니다. 실제 조건은 농장/품종/시기에 따라 조정하세요.</p>
      </div>
    </div>
  </aside>

  <script>
    const base = "assets/videos";
    const STANDARD_ID = "mushroom_S1T18_H90_Lon_S2T15_H80_Lon_T10.mp4";
    const STANDARD_PATH = `${base}/${STANDARD_ID}`;

    // players
    const stdPlayer = document.getElementById("stdPlayer");
    const cmpPlayer = document.getElementById("cmpPlayer");
    const stdStatus = document.getElementById("stdStatus");
    const cmpStatus = document.getElementById("cmpStatus");

    // selectors
    const selS1T = document.getElementById("s1temp");
    const selS1L = document.getElementById("s1light");
    const selS1H = document.getElementById("s1hum");
    const selS2T = document.getElementById("s2temp");
    const selS2H = document.getElementById("s2hum");
    const selS2L = document.getElementById("s2light");
    const selQual = document.getElementById("quality");
    const selAging= document.getElementById("aging");
    const selThinMode = document.getElementById("thinMode");
    const selThinSolo = document.getElementById("thinSolo");

    // buttons
    const playBoth  = document.getElementById("playBoth");
    const pauseBoth = document.getElementById("pauseBoth");
    const syncTime  = document.getElementById("syncTime");

    // manual panel
    const panel = document.getElementById("panel");
    const openManual = document.getElementById("openManual");
    const closeManual = document.getElementById("closeManual");
    openManual.addEventListener("click", ()=>{ panel.classList.add("open"); panel.setAttribute("aria-hidden","false"); });
    closeManual.addEventListener("click", ()=>{ panel.classList.remove("open"); panel.setAttribute("aria-hidden","true"); });

    // panel inner tabs
    document.querySelectorAll(".sidepanel .tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".sidepanel .tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        document.querySelectorAll(".sidepanel .tabpage").forEach(p=>p.style.display="none");
        document.getElementById(btn.dataset.tab).style.display="block";
      });
    });

    // caching HEAD
    const existsCache = new Map();
    async function fileExists(url){
      if(existsCache.has(url)) return existsCache.get(url);
      try{ const r=await fetch(url,{method:"HEAD"}); existsCache.set(url,r.ok); return r.ok; }
      catch{ existsCache.set(url,false); return false; }
    }
    function withCacheBuster(url){ const u=new URL(url,location.href); u.searchParams.set("v",Date.now()); return u.toString(); }

    function buildComboFile(){
      // example: mushroom_S1T18_H90_Lon_S2T15_H80_Lon_T10.mp4
      return `mushroom_S1T${selS1T.value}_H${selS1H.value}_L${selS1L.value}`+
             `_S2T${selS2T.value}_H${selS2H.value}_L${selS2L.value}_T10.mp4`;
    }
    function buildQualityFile(){ return `${selQual.value}.mp4`; }
    function buildAgingFile(){ return `aging.mp4`; }
    function buildThinSoloFile(){ return `thinning_${selThinSolo.value}.mp4`; }

    async function loadToPlayer(player,statusEl,relPath){
      const url = encodeURI(relPath);
      const ok = await fileExists(url);
      if(!ok){
        statusEl.innerHTML = `<span class="err">파일을 찾을 수 없습니다 (404): <code>${relPath}</code></span>`;
        try{player.pause();}catch{}
        player.removeAttribute("src"); player.load(); return false;
      }
      try{player.pause();}catch{}
      player.removeAttribute("src"); player.load();
      player.src = withCacheBuster(url);
      player.muted=true; player.playsInline=true;
      player.onerror = ()=>{ statusEl.innerHTML = `<span class="err">재생 오류: <code>${relPath}</code></span>`; };
      player.oncanplay = ()=>{ statusEl.textContent = `재생 중: ${relPath}`; };
      try{ await player.play(); }catch{ statusEl.innerHTML = `자동재생이 차단됨 → <b>재생</b> 버튼 클릭: <code>${relPath}</code>`; }
      return true;
    }

    function buildComparePath(){
      if(selQual.value!=="none") return `${base}/quality/${buildQualityFile()}`;
      if(selAging.value==="on")  return `${base}/aging/${buildAgingFile()}`;
      if(selThinMode.value==="on" && selThinSolo.value!=="none")
        return `${base}/thinning/${buildThinSoloFile()}`;
      return `${base}/${buildComboFile()}`;
    }
    async function updateCompare(){ await loadToPlayer(cmpPlayer, cmpStatus, buildComparePath()); }

    // buttons
    playBoth.addEventListener("click", ()=>{ stdPlayer.play(); cmpPlayer.play(); });
    pauseBoth.addEventListener("click", ()=>{ stdPlayer.pause(); cmpPlayer.pause(); });
    syncTime.addEventListener("click", ()=>{ try{ cmpPlayer.currentTime = stdPlayer.currentTime; }catch{} });

    // change events
    [selS1T, selS1L, selS1H, selS2T, selS2H, selS2L, selQual, selAging, selThinMode, selThinSolo]
      .forEach(el=> el.addEventListener("change", updateCompare));

    // initial load: standard top, compare current selection
    (async ()=>{
      await loadToPlayer(stdPlayer, stdStatus, STANDARD_PATH);
      await updateCompare();
    })();
  </script>
</body>
</html>
